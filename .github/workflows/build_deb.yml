name: Build DEB Packages

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os_image: "ubuntu:22.04"
            os_version: "jammy"
          - os_image: "ubuntu:24.04"
            os_version: "noble"
    
    container:
      image: ${{ matrix.os_image }}
    
    env:
      ROSDISTRO_INDEX_URL: https://github.com/tianbot/rosdistro/raw/master/index-v4.yaml
      DEBIAN_FRONTEND: noninteractive
      ROS_DISTRO: noetic
      ROS_PYTHON_VERSION: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y \
            python3-pip \
            python3-setuptools \
            python3-catkin-pkg \
            python3-wheel \
            fakeroot \
            dpkg-dev \
            debhelper \
            build-essential \
            cmake \
            git \
            sudo \
            curl \
            gnupg2 \
            lsb-release \
            nasm \
            python3-gnupg \
            python3-pycryptodome \
            bridge-utils \
            libassuan-dev \
            libcaca-dev \
            libfltk1.3-dev \
            libfreeimage-dev \
            libgpg-error-dev \
            libgpgme-dev \
            libgpgmepp-dev \
            libogre-1.9-dev \
            libpoco-dev \
            libsdl1.2-dev \
            libsdl2-dev \
            libsdl-image1.2-dev \
            libslang2-dev \
            liburdfdom-dev \
            liburdfdom-headers-dev \
            libv4l-dev \
            libzzip-dev
          
          # 针对 Ubuntu 22.04/24.04 的 ROS 1 兼容性处理
          # 官方 ROS 1 不支持这些版本，因此不添加官方 apt 仓库（避免 404）
          # 我们依靠本仓库源码构建所有 ROS 组件，rosdep 仅用于安装 Ubuntu 原生系统依赖
          
          # 设置 Git 身份，某些 bloom 操作需要
          git config --global user.email "copilot@example.com"
          git config --global user.name "Github Copilot"
          
          # 使用 pip 安装 ROS 工具以确保在不同版本的 Ubuntu 上都能运行
          # 在 Ubuntu 24.04+ 中由于 PEP 668 需要 --break-system-packages
          pip3 install --upgrade bloom rosdep rosinstall-generator vcstool catkin-tools --break-system-packages || \
          pip3 install --upgrade bloom rosdep rosinstall-generator vcstool catkin-tools
          
          # 手动模拟 rosdep init 使用 tianbot 源
          mkdir -p /etc/ros/rosdep/sources.list.d/
          curl -sSL https://github.com/tianbot/rosdistro/raw/master/rosdep/sources.list.d/20-default.list -o /etc/ros/rosdep/sources.list.d/20-default.list
          
          # 验证文件是否成功下载且不为空
          if [ ! -s /etc/ros/rosdep/sources.list.d/20-default.list ]; then
            echo "错误: 无法下载 rosdep 列表文件"
            exit 1
          fi
          
          # 执行 rosdep update
          rosdep update

      - name: Generate Debian metadata
        run: |
          chmod +x generate.sh
          # 使用 generate.sh 生成 debian 文件夹
          ./generate.sh ${{ matrix.os_version }} noetic

      - name: Build and Install DEB packages
        run: |
          mkdir -p artifacts
          
          # 集中安装所有系统依赖
          # 使用 find 预过滤出合法包路径，解决 rosdep 不支持 --exclude 的问题
          echo "正在安装系统依赖..."
          PKG_PATHS=$(find . -maxdepth 4 -name "package.xml" | grep -vE "/(\.|rosdep|rosdistro|rospkg|test|tests)/" | xargs -n1 dirname)
          rosdep install --from-paths $PKG_PATHS --ignore-src -r -y --os=ubuntu:${{ matrix.os_version }} --rosdistro noetic || echo "部分系统依赖可能无法安装，尝试继续..."

          # 为了解决构建依赖顺序问题，我们需要按拓扑排序构建
          # catkin list --topological 输出格式通常为 "- pkg_name (path)"
          # 我们使用 awk 提取括号中的路径
          catkin list --topological | grep "(" | grep -vE "/(rosdep|rosdistro|rospkg|test|tests)/" | awk -F'[()]' '{print $2}' | while read -r pkg_path; do
            if [ -d "$pkg_path/debian" ]; then
              pkg_normalized_path=$(echo "$pkg_path" | xargs)
              pkg_name=$(basename "$pkg_normalized_path")
              echo "--------------------------------------------------"
              echo "正在构建并安装软件包: $pkg_name ($pkg_normalized_path)"
              echo "--------------------------------------------------"
              
              # 编译
              (cd "$pkg_normalized_path" && dpkg-buildpackage -us -uc -b -d) || { echo "构建 $pkg_name 失败"; continue; }
              
              # 立即安装生成的 deb，以便后续包能够找到依赖
              find "$pkg_normalized_path/.." -maxdepth 1 -name "*.deb" -type f -exec dpkg -i {} + || apt-get install -f -y
            fi
          done
              echo "--------------------------------------------------"
              echo "正在构建并安装软件包: $pkg_name ($pkg_path)"
              echo "--------------------------------------------------"
              
              # 编译
              # -d: 跳过构建依赖检查。理由：虽然我们已尽可能排序安装，但在复杂循环依赖下 -d 仍是必要的。
              (cd "$pkg_path" && dpkg-buildpackage -us -uc -b -d) || { echo "构建 $pkg_name 失败"; continue; }
              
              # 立即安装生成的 deb，以便后续包能够找到依赖（CMake/Headers）
              # dpkg-buildpackage 生成的 deb 通常在源码目录同级
              find "$pkg_path/.." -maxdepth 1 -name "*.deb" -type f -exec dpkg -i {} + || apt-get install -f -y
            fi
          done

      - name: Collect all DEB files
        run: |
          find . -name "*.deb" -type f -exec cp {} artifacts/ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros-pkgs-${{ matrix.os_version }}-debs
          path: artifacts/*.deb
