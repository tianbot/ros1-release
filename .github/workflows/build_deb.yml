name: Build DEB Packages

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os_image: "ubuntu:22.04"
            os_version: "jammy"
          - os_image: "ubuntu:24.04"
            os_version: "noble"
    
    container:
      image: ${{ matrix.os_image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y \
            python3-bloom \
            python3-rosdep \
            python3-rosinstall-generator \
            python3-vcstool \
            fakeroot \
            dpkg-dev \
            debhelper \
            build-essential \
            git \
            sudo
          
          # 修复 rosdep init 在容器中可能遇到的权限问题
          if [ ! -f /etc/ros/rosdep/sources.list.d/20-default.list ]; then
            rosdep init
          fi
          rosdep update

      - name: Generate Debian metadata
        run: |
          chmod +x generate.sh
          # 使用 generate.sh 生成 debian 文件夹
          ./generate.sh ${{ matrix.os_version }} noetic

      - name: Build DEB packages
        run: |
          # 创建存放结果的文件夹
          mkdir -p debs_output
          
          # 遍历所有含有 debian 目录的包
          find . -name "debian" -type d | while read -r debian_path; do
            pkg_dir=$(dirname "$debian_path")
            echo "--------------------------------------------------"
            echo "正在构建软件包: $pkg_dir"
            echo "--------------------------------------------------"
            
            # 安装该包特有的构建依赖
            # 注意：在 noble 上安装 noetic 依赖可能会失败，取决于仓库配置
            rosdep install --from-paths "$pkg_dir" --ignore-src -r -y --os=ubuntu:${{ matrix.os_version }} || true
            
            # 执行打包命令
            # -bx: 二进制打包，忽略源码包错误
            (cd "$pkg_dir" && dpkg-buildpackage -us -uc -b) || echo "构建 $pkg_dir 失败"
          done

      - name: Collect DEB files
        run: |
          # 收集所有生成的 .deb 文件到单一目录
          # dpkg-buildpackage 通常把文件放在软件包目录同级
          mkdir -p artifacts
          find . -name "*.deb" -type f | while read -r deb_file; do
            cp "$deb_file" artifacts/
          done

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros-pkgs-${{ matrix.os_version }}-debs
          path: artifacts/*.deb
