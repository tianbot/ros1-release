name: Build DEB Packages

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  prepare-base:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os_image: "ubuntu:22.04"
            os_version: "jammy"
          - os_image: "ubuntu:24.04"
            os_version: "noble"
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Base Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.base
          build-args: |
            BASE_IMAGE=${{ matrix.os_image }}
            OS_VERSION=${{ matrix.os_version }}
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/ros1-base-${{ matrix.os_version }}:latest
          cache-from: type=gha,scope=base-${{ matrix.os_version }}
          cache-to: type=gha,mode=max,scope=base-${{ matrix.os_version }}

  build:
    needs: prepare-base
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os_image: "ubuntu:22.04"
            os_version: "jammy"
          - os_image: "ubuntu:24.04"
            os_version: "noble"
    
    container:
      image: ghcr.io/${{ github.repository_owner }}/ros1-base-${{ matrix.os_version }}:latest
      options: --user root
    
    env:
      ROSDISTRO_INDEX_URL: https://github.com/tianbot/rosdistro/raw/master/index-v4.yaml
      DEBIAN_FRONTEND: noninteractive
      ROS_DISTRO: noetic
      ROS_PYTHON_VERSION: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update rosdep
        run: |
          # 镜像中虽已配置，但更新 index 确保最新
          rosdep update

      - name: Generate Debian metadata
        run: |
          chmod +x generate.sh
          # 使用 generate.sh 生成 debian 文件夹
          ./generate.sh ${{ matrix.os_version }} noetic

      - name: Install System Dependencies
        run: |
          echo "正在安装系统依赖..."
          # 彻底排除隐藏目录（如 .pc）和测试目录
          PKG_PATHS=$(find . -maxdepth 4 -name "package.xml" | grep -vE "/\.|/(rosdep|rosdistro|rospkg|test|tests)/" | xargs -n1 dirname | sort -u)
          rosdep install --from-paths $PKG_PATHS --ignore-src -r -y --os=ubuntu:${{ matrix.os_version }} --rosdistro noetic || echo "部分系统依赖可能无法安装，尝试继续..."

      - name: Build and Install Source Packages
        run: |
          mkdir -p artifacts
          
          # 使用 Python 进行稳健的拓扑排序，显式排除干扰目录
          ORDERED_PATHS=$(python3 -c "
          import os
          from catkin_pkg.packages import find_packages
          from catkin_pkg.topological_order import topological_order_packages
          
          try:
              # 显式排除包含测试用例和非法包的目录（如 rosdep/test 目录）
              # find_packages 会递归寻找，但 exclude_paths 能防止进入特定子树
              pkgs = find_packages('.', exclude_paths=['rosdep', 'rosdistro', 'rospkg', 'test', 'tests'])
              ordered = topological_order_packages(pkgs)
              for path, pkg in ordered:
                  if path != '.':
                      print(path)
          except Exception as e:
              import sys
              print(f'Error during topological sort: {e}', file=sys.stderr)
              sys.exit(1)
          ")
          
          if [ $? -ne 0 ]; then
            echo "拓扑排序失败，请检查 package.xml 是否完整或路径是否正确。"
            exit 1
          fi
          
          echo "$ORDERED_PATHS" | while read -r pkg_path; do
            if [ -z "$pkg_path" ]; then continue; fi
            
            # 二次核对，确保不构建特定的功能组件目录
            if echo "$pkg_path" | grep -qE "/\.|/(rosdep|rosdistro|rospkg|test|tests)/"; then continue; fi
            
            if [ -d "$pkg_path/debian" ]; then
              pkg_name=$(basename "$pkg_path")
              echo "--------------------------------------------------"
              echo "正在构建并安装软件包: $pkg_name ($pkg_path)"
              echo "--------------------------------------------------"
              
              # 构建镜像（-d 参数跳过针对 apt 中未发布包的构建依赖检查）
              (cd "$pkg_path" && dpkg-buildpackage -us -uc -b -d) || { echo "构建 $pkg_name 失败"; continue; }
              
              # 立即安装生成的 deb，以便后续包能够找到 C++/CMake 依赖
              # 寻找该包父目录下的所有 .deb（如果是多项目目录结构，请确保查找精确）
              PARENT_DIR=$(dirname "$pkg_path")
              find "$PARENT_DIR" -maxdepth 1 -name "*.deb" -type f -exec dpkg -i {} + || apt-get install -f -y
            fi
          done

      - name: Collect all DEB files
        run: |
          find . -name "*.deb" -type f -exec cp {} artifacts/ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros-pkgs-${{ matrix.os_version }}-debs
          path: artifacts/*.deb
