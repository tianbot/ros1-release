name: Build DEB Packages

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  prepare-base:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - os_image: "ubuntu:22.04"
            os_version: "jammy"
          - os_image: "ubuntu:24.04"
            os_version: "noble"
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.base
          build-args: |
            BASE_IMAGE=${{ matrix.os_image }}
            OS_VERSION=${{ matrix.os_version }}
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/ros1-base-${{ matrix.os_version }}:latest
          cache-from: type=gha,scope=base-${{ matrix.os_version }}
          cache-to: type=gha,mode=max,scope=base-${{ matrix.os_version }}

  build-amd64:
    needs: prepare-base
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os_version: "jammy"
            os_image: "ubuntu:22.04"
          - os_version: "noble"
            os_image: "ubuntu:24.04"
    
    container:
      image: ghcr.io/${{ github.repository_owner }}/ros1-base-${{ matrix.os_version }}:latest
      options: --user root
    
    env:
      ROSDISTRO_INDEX_URL: https://github.com/tianbot/rosdistro/raw/master/index-v4.yaml
      DEBIAN_FRONTEND: noninteractive
      ROS_DISTRO: noetic
      ROS_PYTHON_VERSION: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install base dependencies
        shell: bash
        run: |
          # 依赖已在 Docker 基础镜像中预装，跳过
          # bash .github/scripts/setup_base_deps.sh ${{ matrix.os_version }}
          echo "Dependencies pre-installed in Docker image"

      - name: Build and Install Source Packages
        shell: bash
        run: |
          bash .github/scripts/build_debs.sh ${{ matrix.os_version }} noetic

      - name: Collect all DEB files
        run: |
          echo "Artifacts already collected in build script."

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros-pkgs-${{ matrix.os_version }}-amd64-debs
          path: artifacts/*.deb

  build-arm64:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os_version: "jammy"
            os_image: "ubuntu:22.04"
          - os_version: "noble"
            os_image: "ubuntu:24.04"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build and Install Source Packages (arm64)
        shell: bash
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -e ROSDISTRO_INDEX_URL="${ROSDISTRO_INDEX_URL}" \
            -e DEBIAN_FRONTEND=noninteractive \
            -e ROS_DISTRO=noetic \
            -e ROS_PYTHON_VERSION=3 \
            -v "${GITHUB_WORKSPACE}":/ws \
            -w /ws \
            ${{ matrix.os_image }} \
            bash -lc "bash .github/scripts/setup_base_deps.sh ${{ matrix.os_version }} && bash .github/scripts/build_debs.sh ${{ matrix.os_version }} noetic"

      - name: Upload Artifacts (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: ros-pkgs-${{ matrix.os_version }}-arm64-debs
          path: artifacts/*.deb
