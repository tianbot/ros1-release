name: Build DEB Packages

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  prepare-base:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os_image: "ubuntu:22.04"
            os_version: "jammy"
          - os_image: "ubuntu:24.04"
            os_version: "noble"
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Base Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.base
          build-args: |
            BASE_IMAGE=${{ matrix.os_image }}
            OS_VERSION=${{ matrix.os_version }}
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/ros1-base-${{ matrix.os_version }}:latest
          cache-from: type=gha,scope=base-${{ matrix.os_version }}
          cache-to: type=gha,mode=max,scope=base-${{ matrix.os_version }}

  build:
    needs: prepare-base
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os_image: "ubuntu:22.04"
            os_version: "jammy"
          - os_image: "ubuntu:24.04"
            os_version: "noble"
    
    container:
      image: ghcr.io/${{ github.repository_owner }}/ros1-base-${{ matrix.os_version }}:latest
      options: --user root
    
    env:
      ROSDISTRO_INDEX_URL: https://github.com/tianbot/rosdistro/raw/master/index-v4.yaml
      DEBIAN_FRONTEND: noninteractive
      ROS_DISTRO: noetic
      ROS_PYTHON_VERSION: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update rosdep
        run: |
          # 镜像中虽已配置，但更新 index 确保最新
          rosdep update

      - name: Generate Debian metadata
        run: |
          chmod +x generate.sh
          # 使用 generate.sh 生成 debian 文件夹
          ./generate.sh ${{ matrix.os_version }} noetic

      - name: Install System Dependencies
        run: |
          echo "正在更新软件包列表..."
          apt-get update
          
          echo "正在安装系统依赖..."
          # 彻底排除隐藏目录（如 .pc）和测试目录
          PKG_PATHS=$(find . -maxdepth 4 -name "package.xml" | grep -vE "/\.|/(rosdep|rosdistro|rospkg|test|tests)/" | xargs -n1 dirname | sort -u)
          
          # 使用 --skip-keys 忽略那些已经通过 pip 安装或在 24.04 上名称变更的包
          # opencv2 通常映射到 libopencv-dev，但有些规则可能过时
          rosdep install --from-paths $PKG_PATHS --ignore-src -r -y \
            --os=ubuntu:${{ matrix.os_version }} \
            --rosdistro noetic \
            --skip-keys "python3-rospkg python3-catkin-pkg python3-rosdep python3-rosdistro opencv2" \
            || echo "部分系统依赖可能无法安装，尝试继续..."

      - name: Build and Install Source Packages
        shell: bash
        run: |
          mkdir -p artifacts
          export DEB_BUILD_OPTIONS="parallel=$(nproc) nocheck"
          
          # 使用 Python 进行稳健的拓扑排序，显式排除干扰目录
          ORDERED_PATHS=$(python3 -c "
          import os
          from catkin_pkg.packages import find_packages
          from catkin_pkg.topological_order import topological_order_packages
          
          try:
              # 显式排除包含测试用例和非法包的目录
              pkgs = find_packages('.', exclude_paths=['rosdep', 'rosdistro', 'rospkg', 'test', 'tests'])
              ordered = topological_order_packages(pkgs)
              for path, pkg in ordered:
                  if path != '.':
                      print(path)
          except Exception as e:
              import sys
              print(f'Error during topological sort: {e}', file=sys.stderr)
              sys.exit(1)
          ")
          
          if [ $? -ne 0 ]; then
            echo "拓扑排序失败，请检查 package.xml 是否完整或路径是否正确。"
            exit 1
          fi

          BOOTSTRAP_LIST=$(cat <<'EOF'
actionlib/actionlib
angles
bond_core/bond
bond_core/bond_core
bond_core/bondcpp
bond_core/bondpy
bond_core/smclib
catkin
class_loader
cmake_modules
common_msgs/actionlib_msgs
common_msgs/common_msgs
common_msgs/diagnostic_msgs
common_msgs/geometry_msgs
common_msgs/nav_msgs
common_msgs/sensor_msgs
common_msgs/shape_msgs
common_msgs/stereo_msgs
common_msgs/trajectory_msgs
common_msgs/visualization_msgs
common_tutorials/actionlib_tutorials
common_tutorials/common_tutorials
common_tutorials/nodelet_tutorial_math
common_tutorials/pluginlib_tutorials
common_tutorials/turtle_actionlib
control_msgs
control_toolbox
diagnostics/diagnostic_aggregator
diagnostics/diagnostic_analysis
diagnostics/diagnostic_common_diagnostics
diagnostics/diagnostic_updater
diagnostics/diagnostics
diagnostics/self_test
dynamic_reconfigure
executive_smach/executive_smach
executive_smach/smach
executive_smach/smach_msgs
executive_smach/smach_ros
filters
gazebo_ros_pkgs/gazebo_dev
gazebo_ros_pkgs/gazebo_msgs
gazebo_ros_pkgs/gazebo_plugins
gazebo_ros_pkgs/gazebo_ros
gazebo_ros_pkgs/gazebo_ros_control
gazebo_ros_pkgs/gazebo_ros_pkgs
gencpp
geneus
genlisp
genmsg
gennodejs
genpy
geometry
geometry2/tf2
geometry2/tf2_eigen
geometry2/tf2_geometry_msgs
geometry2/tf2_sensor_msgs
geometry2/tf2_kdl
geometry2/tf2_msgs
geometry2/tf2_py
geometry2/tf2_ros
geometry_tutorials/geometry_tutorials
geometry_tutorials/turtle_tf
geometry_tutorials/turtle_tf2
gl_dependency
image_common/camera_calibration_parsers
image_common/camera_info_manager
image_common/image_common
image_common/image_transport
image_common/polled_camera
image_pipeline/camera_calibration
image_pipeline/depth_image_proc
image_pipeline/image_pipeline
image_pipeline/image_proc
image_pipeline/image_publisher
image_pipeline/image_rotate
image_pipeline/image_view
image_pipeline/stereo_image_proc
image_transport_plugins/compressed_depth_image_transport
image_transport_plugins/compressed_image_transport
image_transport_plugins/image_transport_plugins
image_transport_plugins/theora_image_transport
interactive_markers
joint_state_publisher/joint_state_publisher
joint_state_publisher/joint_state_publisher_gui
kdl_parser
laser_assembler
laser_filters
laser_geometry
laser_pipeline
media_export
message_generation
message_runtime
metapackages/desktop
metapackages/desktop_full
metapackages/perception
metapackages/robot
metapackages/ros_base
metapackages/ros_core
metapackages/simulators
metapackages/viz
navigation_msgs/map_msgs
nodelet_core/nodelet
nodelet_core/nodelet_core
nodelet_core/nodelet_topic_tools
pcl_msgs
perception_pcl
pluginlib
python_qt_binding
qt_gui_core/qt_dotgraph
qt_gui_core/qt_gui
qt_gui_core/qt_gui_cpp
qt_gui_core/qt_gui_py_common
qwt_dependency
realtime_tools
resource_retriever
robot_state_publisher
ros/mk
ros/ros
ros/rosbash
ros/rosboost_cfg
ros/rosbuild
ros/rosclean
ros/roscreate
ros/roslang
ros/roslib
ros/rosmake
ros/rosunit
ros_comm/message_filters
ros_comm/ros_comm
ros_comm/rosbag
ros_comm/rosbag_storage
ros_comm/roscpp
ros_comm/rosgraph
ros_comm/roslaunch
ros_comm/roslz4
ros_comm/rosmaster
ros_comm/rosmsg
ros_comm/rosnode
ros_comm/rosout
ros_comm/rosparam
ros_comm/rospy
ros_comm/rosservice
ros_comm/rostest
ros_comm/rostopic
ros_comm/roswtf
ros_comm/topic_tools
ros_comm/xmlrpcpp
ros_comm_msgs/rosgraph_msgs
ros_comm_msgs/std_srvs
ros_control/controller_interface
ros_control/controller_manager
ros_control/controller_manager_msgs
ros_control/hardware_interface
ros_control/joint_limits_interface
ros_control/transmission_interface
ros_controllers/diff_drive_controller
ros_controllers/forward_command_controller
ros_controllers/joint_state_controller
ros_controllers/position_controllers
ros_environment
ros_tutorials/ros_tutorials
ros_tutorials/roscpp_tutorials
ros_tutorials/rospy_tutorials
ros_tutorials/turtlesim
rosbag_migration_rule
rosconsole
rosconsole_bridge
roscpp_core/cpp_common
roscpp_core/roscpp_core
roscpp_core/roscpp_serialization
roscpp_core/roscpp_traits
roscpp_core/rostime
roslint
roslisp
rospack
rqt/rqt_gui
rqt/rqt_gui_cpp
rqt/rqt_gui_py
rqt/rqt_py_common
rqt_action
rqt_bag/rqt_bag
rqt_bag/rqt_bag_plugins
rqt_common_plugins
rqt_console
rqt_dep
rqt_graph
rqt_image_view
rqt_launch
rqt_logger_level
rqt_moveit
rqt_msg
rqt_nav_view
rqt_plot
rqt_pose_view
rqt_publisher
rqt_py_console
rqt_reconfigure
rqt_robot_dashboard
rqt_robot_monitor
rqt_robot_plugins
rqt_robot_steering
rqt_runtime_monitor
rqt_rviz
rqt_service_caller
rqt_shell
rqt_srv
rqt_tf_tree
rqt_top
rqt_topic
rqt_web
rviz
stage
stage_ros
std_msgs
urdf
urdf_sim_tutorial
urdf_tutorial
vision_opencv/cv_bridge
vision_opencv/image_geometry
vision_opencv/vision_opencv
visualization_tutorials/interactive_marker_tutorials
visualization_tutorials/librviz_tutorial
visualization_tutorials/rviz_plugin_tutorials
visualization_tutorials/rviz_python_tutorial
visualization_tutorials/visualization_marker_tutorials
visualization_tutorials/visualization_tutorials
webkit_dependency
xacro
EOF
          )

          is_bootstrap() {
            echo "$BOOTSTRAP_LIST" | grep -qx "$1"
          }

          echo "开始构建并安装基础包..."
          echo "$ORDERED_PATHS" | while read -r pkg_path; do
            if [ -z "$pkg_path" ]; then continue; fi
            if echo "$pkg_path" | grep -qE "/\.|/(rosdep|rosdistro|rospkg|test|tests)/"; then continue; fi
            if ! is_bootstrap "$pkg_path"; then continue; fi
            if [ -d "$pkg_path/debian" ]; then
              pkg_name=$(basename "$pkg_path")
              printf "[bootstrap] 正在构建 %-30s ... " "$pkg_name"
              PARENT_DIR=$(dirname "$pkg_path")
              BEFORE_DEB_LIST=$(find "$PARENT_DIR" -maxdepth 1 -name "*.deb" -type f -printf "%f\n" | sort)
              EXPECTED_VERSION=$(cd "$pkg_path" && dpkg-parsechangelog -S Version 2>/dev/null)
              EXPECTED_ARCH=$(dpkg-architecture -qDEB_BUILD_ARCH 2>/dev/null)
              EXPECTED_PKGS=$(awk '/^Package: /{print $2}' "$pkg_path/debian/control" 2>/dev/null)
              EXPECTED_DEBS=""
              if [ -n "$EXPECTED_VERSION" ] && [ -n "$EXPECTED_ARCH" ] && [ -n "$EXPECTED_PKGS" ]; then
                while read -r p; do
                  if [ -n "$p" ]; then
                    EXPECTED_DEBS="$EXPECTED_DEBS $p"_"$EXPECTED_VERSION"_"$EXPECTED_ARCH".deb
                  fi
                done <<< "$EXPECTED_PKGS"
              fi

              if (cd "$pkg_path" && dpkg-buildpackage -us -uc -b -d -jauto > build.log 2>&1); then
                echo "✅ 成功"
                echo "::group::查看构建日志：$pkg_name"
                cat "$pkg_path/build.log"
                echo "::endgroup::"

                AFTER_DEB_LIST=$(find "$PARENT_DIR" -maxdepth 1 -name "*.deb" -type f -printf "%f\n" | sort)
                NEW_DEBS=$(comm -13 <(echo "$BEFORE_DEB_LIST") <(echo "$AFTER_DEB_LIST"))
                if [ -z "$NEW_DEBS" ]; then
                  if [ -n "$EXPECTED_DEBS" ]; then
                    echo "::warning title=Deb Not Generated::构建 $pkg_name 完成但未发现新增 deb。期望：$EXPECTED_DEBS"
                  else
                    echo "::warning title=Deb Not Generated::构建 $pkg_name 完成但未发现新增 deb。"
                  fi
                else
                  echo "$NEW_DEBS" | while read -r deb_name; do
                    if [ -n "$deb_name" ]; then
                      cp "$PARENT_DIR/$deb_name" artifacts/
                    fi
                  done
                  if ! apt-get install -y ./artifacts/*.deb; then
                    echo "::warning title=Install Failed::安装基础包 deb 失败，尝试继续后续包。"
                  fi
                fi
              else
                echo "❌ 失败"
                echo "--------------------------------------------------"
                echo "构建失败日志: $pkg_name"
                cat "$pkg_path/build.log"
                echo "--------------------------------------------------"
                echo "::warning title=Build Failed::构建 $pkg_name 失败，尝试继续下一个包。"
              fi
            fi
          done

          if [ -f /opt/ros/noetic/setup.bash ]; then
            source /opt/ros/noetic/setup.bash
          else
            echo "::warning title=Setup Not Found::/opt/ros/noetic/setup.bash 不存在，环境未刷新。"
          fi
          
          echo "$ORDERED_PATHS" | while read -r pkg_path; do
            if [ -z "$pkg_path" ]; then continue; fi
            
            # 二次核对，确保不构建特定的功能组件目录
            if echo "$pkg_path" | grep -qE "/\.|/(rosdep|rosdistro|rospkg|test|tests)/"; then continue; fi

            if is_bootstrap "$pkg_path"; then continue; fi
            
            if [ -d "$pkg_path/debian" ]; then
              pkg_name=$(basename "$pkg_path")
              printf "正在构建 %-30s ... " "$pkg_name"
              PARENT_DIR=$(dirname "$pkg_path")
              BEFORE_DEB_LIST=$(find "$PARENT_DIR" -maxdepth 1 -name "*.deb" -type f -printf "%f\n" | sort)
              EXPECTED_VERSION=$(cd "$pkg_path" && dpkg-parsechangelog -S Version 2>/dev/null)
              EXPECTED_ARCH=$(dpkg-architecture -qDEB_BUILD_ARCH 2>/dev/null)
              EXPECTED_PKGS=$(awk '/^Package: /{print $2}' "$pkg_path/debian/control" 2>/dev/null)
              EXPECTED_DEBS=""
              if [ -n "$EXPECTED_VERSION" ] && [ -n "$EXPECTED_ARCH" ] && [ -n "$EXPECTED_PKGS" ]; then
                while read -r p; do
                  if [ -n "$p" ]; then
                    EXPECTED_DEBS="$EXPECTED_DEBS $p"_"$EXPECTED_VERSION"_"$EXPECTED_ARCH".deb
                  fi
                done <<< "$EXPECTED_PKGS"
              fi
              
              # 构建并捕获日志
              if (cd "$pkg_path" && dpkg-buildpackage -us -uc -b -d -jauto > build.log 2>&1); then
                echo "✅ 成功"
                echo "::group::查看构建日志：$pkg_name"
                cat "$pkg_path/build.log"
                echo "::endgroup::"
                
                AFTER_DEB_LIST=$(find "$PARENT_DIR" -maxdepth 1 -name "*.deb" -type f -printf "%f\n" | sort)
                NEW_DEBS=$(comm -13 <(echo "$BEFORE_DEB_LIST") <(echo "$AFTER_DEB_LIST"))
                if [ -z "$NEW_DEBS" ]; then
                  if [ -n "$EXPECTED_DEBS" ]; then
                    echo "::warning title=Deb Not Generated::构建 $pkg_name 完成但未发现新增 deb。期望：$EXPECTED_DEBS"
                  else
                    echo "::warning title=Deb Not Generated::构建 $pkg_name 完成但未发现新增 deb。"
                  fi
                else
                  echo "$NEW_DEBS" | while read -r deb_name; do
                    if [ -n "$deb_name" ]; then
                      cp "$PARENT_DIR/$deb_name" artifacts/
                    fi
                  done
                fi
              else
                echo "❌ 失败"
                echo "--------------------------------------------------"
                echo "构建失败日志: $pkg_name"
                cat "$pkg_path/build.log"
                echo "--------------------------------------------------"
                echo "::warning title=Build Failed::构建 $pkg_name 失败，尝试继续下一个包。"
              fi
            fi
          done
          
          if compgen -G "artifacts/*.deb" > /dev/null; then
            echo "开始安装收集到的 deb 包..."
            if ! apt-get install -y ./artifacts/*.deb; then
              echo "::warning title=Install Failed::统一安装 deb 失败，请检查依赖关系。"
            fi
          else
            echo "::warning title=No Debs Collected::未收集到任何 deb 包，跳过安装。"
          fi

      - name: Collect all DEB files
        run: |
          find . -name "*.deb" -type f -exec cp {} artifacts/ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros-pkgs-${{ matrix.os_version }}-debs
          path: artifacts/*.deb
