name: Build DEB Packages

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  prepare-base:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - os_image: "ubuntu:22.04"
            os_version: "jammy"
          - os_image: "ubuntu:24.04"
            os_version: "noble"
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.base
          build-args: |
            BASE_IMAGE=${{ matrix.os_image }}
            OS_VERSION=${{ matrix.os_version }}
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/ros1-base-${{ matrix.os_version }}:latest
          cache-from: type=gha,scope=base-${{ matrix.os_version }}
          cache-to: type=gha,mode=max,scope=base-${{ matrix.os_version }}

  build-amd64:
    needs: prepare-base
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os_version: "jammy"
            os_image: "ubuntu:22.04"
          - os_version: "noble"
            os_image: "ubuntu:24.04"
    
    container:
      image: ghcr.io/${{ github.repository_owner }}/ros1-base-${{ matrix.os_version }}:latest
      options: --user root
    
    env:
      ROSDISTRO_INDEX_URL: https://github.com/tianbot/rosdistro/raw/master/index-v4.yaml
      DEBIAN_FRONTEND: noninteractive
      ROS_DISTRO: noetic
      ROS_PYTHON_VERSION: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install base dependencies
        shell: bash
        run: |
          # 依赖已在 Docker 基础镜像中预装，跳过
          # bash .github/scripts/setup_base_deps.sh ${{ matrix.os_version }}
          echo "Dependencies pre-installed in Docker image"

      - name: Build and Install Source Packages
        shell: bash
        run: |
          sudo apt-get update
          mkdir -p artifacts
          export DEB_BUILD_OPTIONS="parallel=$(nproc) nocheck"
          
          # 使用 Python 进行稳健的拓扑排序，显式排除干扰目录
          ORDERED_PATHS=$(python3 -c "
          import os
          from catkin_pkg.packages import find_packages
          from catkin_pkg.topological_order import topological_order_packages
          
          try:
              # 显式排除包含测试用例和非法包的目录
              pkgs = find_packages('.', exclude_paths=['rosdep', 'rosdistro', 'rospkg', 'test', 'tests'])
              ordered = topological_order_packages(pkgs)
              for path, pkg in ordered:
                  if path != '.':
                      print(path)
          except Exception as e:
              import sys
              print(f'Error during topological sort: {e}', file=sys.stderr)
              sys.exit(1)
          ")
          
          if [ $? -ne 0 ]; then
            echo "拓扑排序失败，请检查 package.xml 是否完整或路径是否正确。"
            exit 1
          fi

          # 读取 bootstrap 列表并移除回车符 (CR)
          if [ -f .github/bootstrap_packages.txt ]; then
            BOOTSTRAP_LIST=$(cat .github/bootstrap_packages.txt | tr -d '\r')
          else
            echo "::error::缺少 .github/bootstrap_packages.txt 文件"
            exit 1
          fi

          # 辅助函数：判断是否为基础包
          is_bootstrap() {
            local pkg="$1"
            # 兼容带/不带路径的匹配
            echo "$BOOTSTRAP_LIST" | grep -qF "$pkg"
          }
          
          # 辅助函数：刷新 ROS 环境
          refresh_ros_env() {
            if [ -f /opt/ros/noetic/setup.bash ]; then
              source /opt/ros/noetic/setup.bash
            fi
          }

          # --- 阶段 1: 构建基础包 (Bootstrap Packages) ---
          echo "::group::构建基础包 (Bootstrap Phase)"
          echo "$ORDERED_PATHS" | while read -r pkg_path; do
            if [ -z "$pkg_path" ]; then continue; fi
            if echo "$pkg_path" | grep -qE "/\.|/(rosdep|rosdistro|rospkg|test|tests)/"; then continue; fi
            
            # 跳过非 Bootstrap 包
            if ! is_bootstrap "$pkg_path"; then continue; fi
            
            if [ -d "$pkg_path/debian" ]; then
              pkg_name=$(basename "$pkg_path")
              printf "正在构建基础包: %-30s ... " "$pkg_name"
              
              # 构建前刷新环境
              refresh_ros_env
              
              if (cd "$pkg_path" && dpkg-buildpackage -us -uc -b -d -jauto > build.log 2>&1); then
                echo "✅"
                # 收集生成的 DEB
                find "$(dirname "$pkg_path")" -maxdepth 1 -name "*.deb" -type f -exec cp {} artifacts/ \;
                
                # 立即安装生成的 DEB 以满足后续依赖 (显示详细错误)
                sudo apt-get install -y ./artifacts/*.deb || { echo "❌ 安装依赖失败"; exit 1; }
              else
                echo "❌"
                echo "::error::构建失败：$pkg_name"
                tail -n 20 "$pkg_path/build.log"
                exit 1
              fi
            fi
          done
          echo "::endgroup::"
          
          # --- 阶段 2: 构建其余包 (Remaining Packages) ---
          echo "::group::构建应用包 (Application Phase)"
          echo "$ORDERED_PATHS" | while read -r pkg_path; do
            if [ -z "$pkg_path" ]; then continue; fi
            if echo "$pkg_path" | grep -qE "/\.|/(rosdep|rosdistro|rospkg|test|tests)/"; then continue; fi
            
            # 跳过已构建的 Bootstrap 包
            if is_bootstrap "$pkg_path"; then continue; fi
            
            if [ -d "$pkg_path/debian" ]; then
              pkg_name=$(basename "$pkg_path")
              printf "正在构建应用包: %-30s ... " "$pkg_name"
              
              refresh_ros_env
              
              if (cd "$pkg_path" && dpkg-buildpackage -us -uc -b -d -jauto > build.log 2>&1); then
                 echo "✅"
                 # 收集
                 find "$(dirname "$pkg_path")" -maxdepth 1 -name "*.deb" -type f -exec cp {} artifacts/ \;
                 # 安装，以便同层级后续包使用
                 apt-get install -y ./artifacts/*.deb > /dev/null 2>&1 || true
              else
                 echo "❌"
                 echo "::warning::构建失败：$pkg_name (查看 artifact 中的 build.log)"
                 # 对于非核心包，允许失败继续
                 cp "$pkg_path/build.log" "artifacts/${pkg_name}_build.log"
              fi
            fi
          done
          echo "::endgroup::"
                fi
              else
                echo "❌ 失败"
                echo "--------------------------------------------------"
                echo "构建失败日志: $pkg_name"
                cat "$pkg_path/build.log"
                echo "--------------------------------------------------"
                echo "::warning title=Build Failed::构建 $pkg_name 失败，尝试继续下一个包。"
              fi
            fi
          done

          echo "--------------------------------------------------"
          echo "Bootstrap 阶段完成"
          echo "--------------------------------------------------"

          # 再次刷新环境
          refresh_ros_env
          
          echo "开始构建其余包 (Main Phase)..."
          echo "$ORDERED_PATHS" | while read -r pkg_path; do
            if [ -z "$pkg_path" ]; then continue; fi
            if echo "$pkg_path" | grep -qE "/\.|/(rosdep|rosdistro|rospkg|test|tests)/"; then continue; fi

            # 跳过已构建的 bootstrap 包
            if is_bootstrap "$pkg_path"; then continue; fi
            
            if [ -d "$pkg_path/debian" ]; then
              pkg_name=$(basename "$pkg_path")
              printf "[main] 正在构建 %-30s ... " "$pkg_name"
              PARENT_DIR=$(dirname "$pkg_path")
              BEFORE_DEB_LIST=$(find "$PARENT_DIR" -maxdepth 1 -name "*.deb" -type f -printf "%f\n" | sort)
              
              # 确保依赖环境生效
              refresh_ros_env
              
              if (cd "$pkg_path" && dpkg-buildpackage -us -uc -b -d -jauto > build.log 2>&1); then
                echo "✅ 成功"
                AFTER_DEB_LIST=$(find "$PARENT_DIR" -maxdepth 1 -name "*.deb" -type f -printf "%f\n" | sort)
                NEW_DEBS=$(comm -13 <(echo "$BEFORE_DEB_LIST") <(echo "$AFTER_DEB_LIST"))
                
                if [ -n "$NEW_DEBS" ]; then
                   echo "$NEW_DEBS" | while read -r deb_name; do
                     [ -n "$deb_name" ] && cp "$PARENT_DIR/$deb_name" artifacts/
                   done
                   # 立即安装，以供后续包依赖
                   apt-get install -y ./artifacts/*.deb || echo "::warning::Install failed for $pkg_name"
                fi
              else
                echo "❌ 失败"
                cat "$pkg_path/build.log"
              fi
            fi
          done
                cat "$pkg_path/build.log"
                echo "::endgroup::"
                
                AFTER_DEB_LIST=$(find "$PARENT_DIR" -maxdepth 1 -name "*.deb" -type f -printf "%f\n" | sort)
                NEW_DEBS=$(comm -13 <(echo "$BEFORE_DEB_LIST") <(echo "$AFTER_DEB_LIST"))
                if [ -z "$NEW_DEBS" ]; then
                  if [ -n "$EXPECTED_DEBS" ]; then
                    echo "::warning title=Deb Not Generated::构建 $pkg_name 完成但未发现新增 deb。期望：$EXPECTED_DEBS"
                  else
                    echo "::warning title=Deb Not Generated::构建 $pkg_name 完成但未发现新增 deb。"
                  fi
                else
                  echo "$NEW_DEBS" | while read -r deb_name; do
                    if [ -n "$deb_name" ]; then
                      cp "$PARENT_DIR/$deb_name" artifacts/
                    fi
                  done
                fi
              else
                echo "❌ 失败"
                echo "--------------------------------------------------"
                echo "构建失败日志: $pkg_name"
                cat "$pkg_path/build.log"
                echo "--------------------------------------------------"
                echo "::warning title=Build Failed::构建 $pkg_name 失败，尝试继续下一个包。"
              fi
            fi
          done
          
          if compgen -G "artifacts/*.deb" > /dev/null; then
            echo "开始安装收集到的 deb 包..."
            if ! apt-get install -y ./artifacts/*.deb; then
              echo "::warning title=Install Failed::统一安装 deb 失败，请检查依赖关系。"
            fi
          else
            echo "::warning title=No Debs Collected::未收集到任何 deb 包，跳过安装。"
          fi

      - name: Collect all DEB files
        run: |
          echo "Artifacts already collected in build script."

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros-pkgs-${{ matrix.os_version }}-amd64-debs
          path: artifacts/*.deb

  build-arm64:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os_version: "jammy"
            os_image: "ubuntu:22.04"
          - os_version: "noble"
            os_image: "ubuntu:24.04"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build and Install Source Packages (arm64)
        shell: bash
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -e ROSDISTRO_INDEX_URL="${ROSDISTRO_INDEX_URL}" \
            -e DEBIAN_FRONTEND=noninteractive \
            -e ROS_DISTRO=noetic \
            -e ROS_PYTHON_VERSION=3 \
            -v "${GITHUB_WORKSPACE}":/ws \
            -w /ws \
            ${{ matrix.os_image }} \
            bash -lc "bash .github/scripts/setup_base_deps.sh ${{ matrix.os_version }} && bash .github/scripts/build_debs.sh ${{ matrix.os_version }} noetic"

      - name: Upload Artifacts (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: ros-pkgs-${{ matrix.os_version }}-arm64-debs
          path: artifacts/*.deb
